/// <reference path="JQuery/jquery-1.7.1-vsdoc.js" />

var globalGuidID = '';
var sendOTPRequest = null;

var ResponseID =
    {
        SendOTPRequest: 0,
        VerifyOTP: 1,
        InitScrambler: 2
    }

var Statuses =
    {
        FAILURE: 0,
        SUCCESS: 1
    }


var ResponseCurrent = ResponseID.SendOTPRequest;

$(document).ready(function () {
    
    var $userName = $$('UserName');
    if ($userName.length === 0 || $userName.val().length === 0) {
        if ($$('txtUserID').val() === '') {
            ResetForm();
            $$("txtUserID").focus();
        }
        else {
            $$("txtLast4Digits").focus();
        }
    }
    else {
        setTimeout(function () {
            $$("Password").focus();
        });
    }

    $(".boxy input[inputField=true]:visible").live("keypress", function (e) {

        if (e.keyCode == 13) // Enter
        {
            $$('submitForm').click();
        }
    });

    function submitForm() {

        if (validateForm('.login-otp-form')) {

            loginContinue();
        }
    }

    $$('submitForm').click(function (e) {

        setTimeout(function () { submitForm(); }, 10);

    });

    $('input.onlyint').keypress(function (e) {
        return onlyNumbers(e);
    });

    $$('txtUserID').blur(function () {
        var orgLength = $$('txtUserID').val().length;
        if (orgLength < 3) return;

        var leadingZero = "";
        for (var i = 0; i < 9 - orgLength; i++) {
            leadingZero += "0";
        }

        $$('txtUserID').val(leadingZero + $$('txtUserID').val());
    });

});


function SendOTPRequest() {
    this.userID = '';
    this.last4Digits = '';
    this.textChekingSigns = '';
}

function VerifyOTPRequest() {
    this.token = '';
    this.otp = '';
}

Date.now = Date.now || function () { return +new Date; };

function loginContinue() {
    if (window.waitingForOTP) return;
    window.waitingForOTP = true;

    sendOTPRequest = new SendOTPRequest();
    sendOTPRequest.userID = $$('txtUserID').val();
    sendOTPRequest.last4Digits = $$('txtLast4Digits').val();
    sendOTPRequest.textChekingSigns = $$('txtChekingSigns').val();

    var orgLength = sendOTPRequest.userID.length;

    var leadingZero = "";
    for (var i = 0; i < 9 - orgLength; i++) {
        leadingZero += "0";
    }

    sendOTPRequest.userID = leadingZero + sendOTPRequest.userID;

    if ($$("loginPasswordDiv").css('display') == 'none') {
        ResponseCurrent = ResponseID.SendOTPRequest;
        executeRequest(location.pathname + "/SendSmsToCustomer", '{"sendOTPRequest":' + JSON.stringify(sendOTPRequest) + '}', parseLoginOtpResponse, onError, function () { $$('txtUserID').addClass('ajax_load_ltr') }, onGeneralCompleteLoginOtpDelegate);
        
        if (!window.img_captcha_scr) window.img_captcha_scr = $('.img_captcha').attr('src');

        var $img_captcha = $('.img_captcha').removeAttr('src');

        setTimeout(function () { $img_captcha.attr('src', window.img_captcha_scr + "&" + Date.now()); }, 1000);

        $('.otp-captchatext').val('');

        CallGoogleAnalyticsEventClick("RequestPassword");

        //window.waitingForOTP = false;
    }
    else {
        setTimeout(function () { $$("submitForm").prop('disabled', true).css('opacity', '0.3').css('cursor', 'default') }, 100);
        VerifyOTPAndExec805();
    }

    return false;
}

function VerifyOTPAndExec805() {

    var _verifyOTPRequest = new VerifyOTPRequest();

    _verifyOTPRequest.token = globalGuidID;
    _verifyOTPRequest.otp = $$('txtPassword').val();

    ResponseCurrent = ResponseID.VerifyOTP;
    executeRequest("Login.aspx/VerifyOTP", '{"verifyOTPRequest":' + JSON.stringify(_verifyOTPRequest) + '}', parseLoginOtpResponse, onError, function () { $$('txtUserID').addClass('ajax_load_ltr') }, onGeneralCompleteLoginOtpDelegate);
}

function onGeneralCompleteLoginOtpDelegate() {
    $(".ajax_load_ltr").removeClass("ajax_load_ltr");
    window.waitingForOTP = false;
}

function InitScrambler() {

    ResponseCurrent = ResponseID.InitScrambler;
    executeRequest("Login.aspx/InitScrambler", '{}', parseLoginOtpResponse, onError, function () { $$('txtChekingSigns').addClass('ajax_load_ltr') }, onGeneralCompleteLoginOtpDelegate);
}

function parseLoginOtpResponse(p_content) {
    if (p_content.Status == Statuses.SUCCESS) { // SUCCESS
        var isPostMessageFired = false;

        switch (ResponseCurrent) {

            case ResponseID.SendOTPRequest:
            default:
                CallGoogleAnalyticsEventClick("PasswordSent");
                $("div.login-otp-form div.login-continue input#submitForm").addClass('step2');
                $$("loginPasswordDiv").slideDown(1000, function () {
                    $$("txtPassword").focus();
                    $("#otpSubTitle").show();
                });
                var chatTimeOut = setTimeout(function () {
                    $(".btnChat").show();
                }, 20000);

                $$("txtPassword").keypress(function () {
                    clearTimeout(chatTimeOut);
                });
                $$("loginPhoneRemarksDiv2").slideDown(1000);
                $$("loginPhoneRemarksDiv1").slideUp();
                $$("LoginOtpCaptcha").slideUp(500);
                $$("lblPhoneRemark1").html($$("lblPhoneRemark1").html().replace("9999999", "<span dir='ltr'>" + p_content.PhoneNumber + "</span>"));
                $$("txtUserID").prop("disabled", true);
                $$("txtLast4Digits").prop("disabled", true);
                globalGuidID = p_content.Token;
                if (p_content.OTP) {
                    $$('txtPassword').val(p_content.OTP);
                    window.waitingForOTP = false;
                    loginContinue();
                }

                break;
            case ResponseID.VerifyOTP:                
                var guid = getParameterByName("guid");
                if (p_content.isNotifyChat && window.opener &&
                    guid && window.opener.location.href.indexOf("chat") > -1 && !isPostMessageFired) {
                    isPostMessageFired = true;
                    try {                        
                        var chatWin = window.open(window.opener.location.href, '', 'width=500,height=600');                        
                        var postMessageData = chatWin ? 1 : 0;
                        (window.windowProxy || window.opener).postMessage(postMessageData, '*'); //"https://chat.cal-online.co.il/chat/rchat.aspx");
                    }
                    catch (e) {
                        console.log(e);
                    }
                }

                CallGoogleAnalyticsEventClick("PasswordCorrect");

                var hrefTimeOut = setTimeout(function () {
                    location.href = p_content.RedirectURL;
                }, 1000);


                break;
            case ResponseID.InitScrambler:
                $(".captcha_image").html('');
                //$$("imgScrambler").attr("src", "../../Scrambler/ScramblerHandler.ashx?p=" + p_content.NewGuid);
                var image = $("<img>");
                image.attr("id", "imgScrambler");
                image.attr("src", "../../Scrambler/ScramblerHandler.ashx?p=" + p_content.NewGuid);
                //image.attr("height", "60");
                //image.attr("width", "60");

                $(".captcha_image").append(image);

                break;


        }

    }
    else { // FAILURE

        CallGoogleAnalyticsEventClick("GeneralError");

        CheckForResetPageAndStertOver(p_content.SeverityPhrase);

        if (p_content.NeedToShowCaptcha) {
            InitScrambler();
            $$("LoginOtpCaptcha").slideDown(500, function () {
                $$("txtChekingSigns").focus();
            });
        }

        $$("errorSummaryDiv").slideDown(300);
        insertErrorLayer($$("errorSummaryDiv"), p_content.Message);
    }

}


function CallGoogleAnalyticsEventClick(p_event) {

    var currentStepControlName = "LoginOTP";
    var GoogleAnaliticsFolderLocation = "CalOnline";

    //////////////////////////////
    // Begin - Google Analytics //
    //////////////////////////////
    try {
        TrackingEventClick(currentStepControlName + "-" + p_event, GoogleAnaliticsFolderLocation);
    }
    catch (e) { }
    ////////////////////////////
    // End - Google Analytics //
    ////////////////////////////
}


function ResetForm() {

    $$('txtUserID').val('');
    $$('txtLast4Digits').val('');
    $$("txtUserID").prop("disabled", false);
    $$("txtLast4Digits").prop("disabled", false);
    $$('txtPassword').val('');
    $$("loginPasswordDiv").slideUp(1000);
    $$("loginPhoneRemarksDiv2").slideUp(1000);
    $$("loginPhoneRemarksDiv1").slideDown(1000);
    $$("lblPhoneRemark1").find("span").replaceWith("9999999");

    setTimeout(function () { $$("submitForm").prop('disabled', false).css('opacity', '1.0').css('cursor', 'pointer').removeAttr('disabled'); }, 100);
}




function CheckForResetPageAndStertOver(SeverityPhrase) {

    var IsResetPage = false;

    switch (SeverityPhrase) {
        case "W_003":
        case "W_005":
        case "W_006":
        case "W_007":
            IsResetPage = true;
            break;
        default:
            IsResetPage = false;
            break;
    }

    if (IsResetPage) {

        $$('txtUserID').val('');
        $$('txtLast4Digits').val('');
        $$("txtUserID").prop("disabled", false);
        $$("txtLast4Digits").prop("disabled", false);
        $$('txtPassword').val('');
        $$("loginPasswordDiv").slideUp(1000);
        $$("loginPhoneRemarksDiv2").slideUp(1000);
        $$("loginPhoneRemarksDiv1").slideDown(1000);
    }

    setTimeout(function () { $$("submitForm").prop('disabled', false).css('opacity', '1.0').css('cursor', 'pointer').removeAttr('disabled'); }, 100);
}

function showFormFieldError(p_control, p_text) {

    var parent = null;
    var children = p_control.find('[inputField=true]');

    if (children.length > 0) {
        children.each(function () {
            $(this).attr("has-error", true)
            animateErrorBorder($(this));
        });

        parent = p_control;
    }
    else {
        p_control.attr("has-error", true);

        animateErrorBorder(p_control);

        parent = p_control.parents(".control");
    }

    insertErrorLayer(parent, p_text);
}

function animateErrorBorder(p_control) {
    p_control.animate({ borderTopColor: '#FF0000', borderLeftColor: '#FF0000', borderBottomColor: '#FF0000', borderRightColor: '#FF0000' }, { duration: 300 });
}

function insertErrorLayer(p_errorParent, p_text) {
    if (p_text != undefined && p_text != "") {
        var error = $('<div class="error">' + p_text + '</div>');
        $(error).appendTo(p_errorParent);
        error.fadeIn(300);
    }
}

function resetValidationsForm() {
    $$("errorSummaryDiv").slideUp(100);
    $(document).find(".error").remove();
    $(document).find("[has-error]").animate(
        { borderTopColor: '#CDCBC8', borderLeftColor: '#CDCBC8', borderBottomColor: '#CDCBC8', borderRightColor: '#CDCBC8' },
        { duration: 300 });

    $(document).find("[has-error]").removeAttr("has-error");
}

function validateForm(p_formUiSelector) {
    //debugger;
    resetValidationsForm();

    var textboxes = $(p_formUiSelector).find(".cal_text_box:visible").not(".ui-autocomplete-input");

    var isValid = true;
    //var generalRegExp = "[A-Z]|[0-9]"
    var regExp;
    var JQCtrl;
    var ctrlID;
    var isMandatory;
    var isDepend;

    textboxes.each(function () {
        isMandatory = false;
        _isValid = true;
        JQCtrl = $(this);
        ctrlID = JQCtrl.attr("id");
        regExp = getVldHiddenField(ctrlID, "regExpHidden");
        customVldFunc = getVldHiddenField(ctrlID, "customVldHidden");
        trimmedValue = $.trim(JQCtrl.val());

        if (JQCtrl.attr("mandatory") != null && (trimmedValue.length == 0)) {

            isMandatory = true;

            if (isMandatory && trimmedValue.length == 0) {
                var msg = getVldHiddenField(ctrlID, "mandatoryHidden").attr("value");
                showFormFieldError(JQCtrl, msg);
                _isValid = isValid = false;
            }
            else {
                hideFormFieldError(JQCtrl);
                _isValid = isValid = true;
            }
        }

        if (_isValid) {
            if (regExp != null && regExp.length > 0 && trimmedValue.length > 0) {
                var reg = new RegExp(regExp.attr("value"));
                if (!reg.test(JQCtrl.val())) {
                    var msg = getVldHiddenField(ctrlID, "regMsgHidden").attr("value");
                    showFormFieldError(JQCtrl, msg);
                    _isValid = isValid = isValid && false;
                }
            }
        }

        if (_isValid) {
            if (customVldFunc != null && customVldFunc.length > 0) {
                //MICHAEL FIX :  CHECK IF ONE HAS ALREADY PASSED ARGS TO THE VALIDATOR FUNC!
                var func = customVldFunc.attr("value");
                if (func.indexOf("(") == -1 && func.indexOf(")") == -1) {
                    func = func + "('" + ctrlID + "')";
                }
                else {
                    var pattSubstArg = /SUBSTTHISARG\{\d{1}\}/i;
                    func = func.replace(pattSubstArg, ctrlID);
                }

                //MICHAEL FIX END
                eval(func);
            }
        }

    });



    // Check all the rest that has attribure "has-error"
    if ($(p_formUiSelector).find("[has-error]").length > 0)
        isValid = isValid && false;

    return isValid;

}

function disableLoginOTP() {
    $(function () {
        $("div.login-otp-form").empty().html("<div id='FormAreaNoBorder_FormArea_CalFrameControl2'><table cellpadding=\"0\" cellspacing=\"0\" class=\"white_info\"><tbody><tr><td class=\"up_right\"></td><td class=\"up_center\"></td><td class=\"up_left\"></td></tr><tr><td class=\"displayimage\"></td><td colspan=\"2\" class=\"center\"><div id=\"LoginErr\" class=\"fSize15px\" style=\"\">השירות אינו זמין כעת. לקבלת מידע יש לפנות למוקד שירות לקוחות בטלפון 03-5726444.</div></td></tr><tr><td class=\"down_right\"></td><td class=\"down_center\"></td><td class=\"down_left\"></td></tr></tbody></table></div>");
    });
}